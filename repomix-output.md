This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-08-13 14:04:18

# File Summary

## Purpose:

This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format:

The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
   a. A header with the file path (## File: path/to/file)
   b. The full contents of the file in a code block

## Usage Guidelines:

- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes:

- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

## Additional Information:

For more information about Repomix, visit: https://github.com/andersonby/python-repomix


# Repository Structure

```
extension
  media
    assets
      index-CndG0YVx.js
      index-CzoosWkT.css
    index.html
  package.json
  src
    extension.ts
    git.ts
    graph.ts
    lsp.ts
    util.ts
  tsconfig.json
package.json
README.md
webview
  index.html
  package.json
  src
    App.tsx
    code
      CodeCard.tsx
      highlight.ts
    layout.ts
    main.tsx
    reactflow-node-types.tsx
    styles.css
  tsconfig.json
  vite.config.ts
```

# Repository Files


## extension/media/assets/index-CzoosWkT.css

```css
.react-flow{direction:ltr}.react-flow__container{position:absolute;width:100%;height:100%;top:0;left:0}.react-flow__pane{z-index:1;cursor:-webkit-grab;cursor:grab}.react-flow__pane.selection{cursor:pointer}.react-flow__pane.dragging{cursor:-webkit-grabbing;cursor:grabbing}.react-flow__viewport{transform-origin:0 0;z-index:2;pointer-events:none}.react-flow__renderer{z-index:4}.react-flow__selection{z-index:6}.react-flow__nodesselection-rect:focus,.react-flow__nodesselection-rect:focus-visible{outline:none}.react-flow .react-flow__edges{pointer-events:none;overflow:visible}.react-flow__edge-path,.react-flow__connection-path{stroke:#b1b1b7;stroke-width:1;fill:none}.react-flow__edge{pointer-events:visibleStroke;cursor:pointer}.react-flow__edge.animated path{stroke-dasharray:5;-webkit-animation:dashdraw .5s linear infinite;animation:dashdraw .5s linear infinite}.react-flow__edge.animated path.react-flow__edge-interaction{stroke-dasharray:none;-webkit-animation:none;animation:none}.react-flow__edge.inactive{pointer-events:none}.react-flow__edge.selected,.react-flow__edge:focus,.react-flow__edge:focus-visible{outline:none}.react-flow__edge.selected .react-flow__edge-path,.react-flow__edge:focus .react-flow__edge-path,.react-flow__edge:focus-visible .react-flow__edge-path{stroke:#555}.react-flow__edge-textwrapper{pointer-events:all}.react-flow__edge-textbg{fill:#fff}.react-flow__edge .react-flow__edge-text{pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.react-flow__connection{pointer-events:none}.react-flow__connection .animated{stroke-dasharray:5;-webkit-animation:dashdraw .5s linear infinite;animation:dashdraw .5s linear infinite}.react-flow__connectionline{z-index:1001}.react-flow__nodes{pointer-events:none;transform-origin:0 0}.react-flow__node{position:absolute;-webkit-user-select:none;-moz-user-select:none;user-select:none;pointer-events:all;transform-origin:0 0;box-sizing:border-box;cursor:-webkit-grab;cursor:grab}.react-flow__node.dragging{cursor:-webkit-grabbing;cursor:grabbing}.react-flow__nodesselection{z-index:3;transform-origin:left top;pointer-events:none}.react-flow__nodesselection-rect{position:absolute;pointer-events:all;cursor:-webkit-grab;cursor:grab}.react-flow__handle{position:absolute;pointer-events:none;min-width:5px;min-height:5px;width:6px;height:6px;background:#1a192b;border:1px solid white;border-radius:100%}.react-flow__handle.connectionindicator{pointer-events:all;cursor:crosshair}.react-flow__handle-bottom{top:auto;left:50%;bottom:-4px;transform:translate(-50%)}.react-flow__handle-top{left:50%;top:-4px;transform:translate(-50%)}.react-flow__handle-left{top:50%;left:-4px;transform:translateY(-50%)}.react-flow__handle-right{right:-4px;top:50%;transform:translateY(-50%)}.react-flow__edgeupdater{cursor:move;pointer-events:all}.react-flow__panel{position:absolute;z-index:5;margin:15px}.react-flow__panel.top{top:0}.react-flow__panel.bottom{bottom:0}.react-flow__panel.left{left:0}.react-flow__panel.right{right:0}.react-flow__panel.center{left:50%;transform:translate(-50%)}.react-flow__attribution{font-size:10px;background:#ffffff80;padding:2px 3px;margin:0}.react-flow__attribution a{text-decoration:none;color:#999}@-webkit-keyframes dashdraw{0%{stroke-dashoffset:10}}@keyframes dashdraw{0%{stroke-dashoffset:10}}.react-flow__edgelabel-renderer{position:absolute;width:100%;height:100%;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.react-flow__edge.updating .react-flow__edge-path{stroke:#777}.react-flow__edge-text{font-size:10px}.react-flow__node.selectable:focus,.react-flow__node.selectable:focus-visible{outline:none}.react-flow__node-default,.react-flow__node-input,.react-flow__node-output,.react-flow__node-group{padding:10px;border-radius:3px;width:150px;font-size:12px;color:#222;text-align:center;border-width:1px;border-style:solid;border-color:#1a192b;background-color:#fff}.react-flow__node-default.selectable:hover,.react-flow__node-input.selectable:hover,.react-flow__node-output.selectable:hover,.react-flow__node-group.selectable:hover{box-shadow:0 1px 4px 1px #00000014}.react-flow__node-default.selectable.selected,.react-flow__node-default.selectable:focus,.react-flow__node-default.selectable:focus-visible,.react-flow__node-input.selectable.selected,.react-flow__node-input.selectable:focus,.react-flow__node-input.selectable:focus-visible,.react-flow__node-output.selectable.selected,.react-flow__node-output.selectable:focus,.react-flow__node-output.selectable:focus-visible,.react-flow__node-group.selectable.selected,.react-flow__node-group.selectable:focus,.react-flow__node-group.selectable:focus-visible{box-shadow:0 0 0 .5px #1a192b}.react-flow__node-group{background-color:#f0f0f040}.react-flow__nodesselection-rect,.react-flow__selection{background:#0059dc14;border:1px dotted rgba(0,89,220,.8)}.react-flow__nodesselection-rect:focus,.react-flow__nodesselection-rect:focus-visible,.react-flow__selection:focus,.react-flow__selection:focus-visible{outline:none}.react-flow__controls{box-shadow:0 0 2px 1px #00000014}.react-flow__controls-button{border:none;background:#fefefe;border-bottom:1px solid #eee;box-sizing:content-box;display:flex;justify-content:center;align-items:center;width:16px;height:16px;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;user-select:none;padding:5px}.react-flow__controls-button:hover{background:#f4f4f4}.react-flow__controls-button svg{width:100%;max-width:12px;max-height:12px}.react-flow__controls-button:disabled{pointer-events:none}.react-flow__controls-button:disabled svg{fill-opacity:.4}.react-flow__minimap{background-color:#fff}.react-flow__minimap svg{display:block}.react-flow__resize-control{position:absolute}.react-flow__resize-control.left,.react-flow__resize-control.right{cursor:ew-resize}.react-flow__resize-control.top,.react-flow__resize-control.bottom{cursor:ns-resize}.react-flow__resize-control.top.left,.react-flow__resize-control.bottom.right{cursor:nwse-resize}.react-flow__resize-control.bottom.left,.react-flow__resize-control.top.right{cursor:nesw-resize}.react-flow__resize-control.handle{width:4px;height:4px;border:1px solid #fff;border-radius:1px;background-color:#3367d9;transform:translate(-50%,-50%)}.react-flow__resize-control.handle.left{left:0;top:50%}.react-flow__resize-control.handle.right{left:100%;top:50%}.react-flow__resize-control.handle.top{left:50%;top:0}.react-flow__resize-control.handle.bottom{left:50%;top:100%}.react-flow__resize-control.handle.top.left,.react-flow__resize-control.handle.bottom.left{left:0}.react-flow__resize-control.handle.top.right,.react-flow__resize-control.handle.bottom.right{left:100%}.react-flow__resize-control.line{border-color:#3367d9;border-width:0;border-style:solid}.react-flow__resize-control.line.left,.react-flow__resize-control.line.right{width:1px;transform:translate(-50%);top:0;height:100%}.react-flow__resize-control.line.left{left:0;border-left-width:1px}.react-flow__resize-control.line.right{left:100%;border-right-width:1px}.react-flow__resize-control.line.top,.react-flow__resize-control.line.bottom{height:1px;transform:translateY(-50%);left:0;width:100%}.react-flow__resize-control.line.top{top:0;border-top-width:1px}.react-flow__resize-control.line.bottom{border-bottom-width:1px;top:100%}:root{color-scheme:dark}body,html,#root{margin:0;height:100%;background:#0b0e12;color:#cdd6f4;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,sans-serif}.root{height:100%}.toolbar{position:absolute;top:10px;left:10px;z-index:10;display:flex;gap:6px}.toolbar button{background:#111827;border:1px solid #1f2937;color:#e5e7eb;padding:6px 10px;border-radius:8px;cursor:pointer}.file-node{width:100%;height:100%;background:#0d1117;border:1px solid #1f2937;border-radius:12px;overflow:hidden;box-shadow:0 0 0 1px #0b1220 inset}.file-node-header{background:#0b1220;padding:6px 10px;font-weight:600;font-size:12px;letter-spacing:.3px;border-bottom:1px solid #1f2937;cursor:default}.code-card{height:calc(100% - 30px);overflow:auto}.code-card .file-title{display:none}pre.hljs{margin:0;padding:8px 10px;font-size:12px;line-height:1.35}.preview{font-size:11px;opacity:.8;padding:8px}
```

## extension/media/index.html

```html
<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; img-src vscode-resource: https: data:; style-src 'unsafe-inline' __CSP__; script-src __CSP__; font-src __CSP__; connect-src __CSP__;" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Code Canvas</title>
  <script type="module" crossorigin src="./assets/index-CndG0YVx.js"></script>
  <link rel="stylesheet" crossorigin href="./assets/index-CzoosWkT.css">
</head>

<body>
    <div id="root"></div>

</body>

</html>
```

## extension/package.json

```json
{
    "name": "code-canvas",
    "displayName": "Code Canvas",
    "publisher": "code-canvas",
    "version": "0.0.1",
    "engines": {
        "vscode": "^1.90.0"
    },
    "categories": [
        "Other"
    ],
    "activationEvents": [
        "onCommand:codeCanvas.open",
        "onCommand:codeCanvas.openChanged",
        "onStartupFinished"
    ],
    "main": "dist/extension.js",
    "contributes": {
        "commands": [
            {
                "command": "codeCanvas.open",
                "title": "Code Canvas: Open"
            },
            {
                "command": "codeCanvas.openChanged",
                "title": "Code Canvas: Open Changed Files"
            },
            {
                "command": "codeCanvas.layout.custom",
                "title": "Code Canvas: Layout – Custom"
            },
            {
                "command": "codeCanvas.layout.dagre",
                "title": "Code Canvas: Layout – Dagre"
            },
            {
                "command": "codeCanvas.layout.elk",
                "title": "Code Canvas: Layout – ELK"
            },
            {
                "command": "codeCanvas.layout.force",
                "title": "Code Canvas: Layout – Force"
            },
            {
                "command": "codeCanvas.toggleRefs",
                "title": "Code Canvas: Toggle Refs"
            }
        ],
        "keybindings": [
            {
                "command": "codeCanvas.openChanged",
                "key": "shift+o"
            },
            {
                "command": "codeCanvas.layout.custom",
                "key": "shift+1"
            },
            {
                "command": "codeCanvas.layout.dagre",
                "key": "shift+2"
            },
            {
                "command": "codeCanvas.layout.elk",
                "key": "shift+3"
            },
            {
                "command": "codeCanvas.layout.force",
                "key": "shift+4"
            },
            {
                "command": "codeCanvas.toggleRefs",
                "key": "r"
            }
        ]
    },
    "scripts": {
        "vscode:prepublish": "npm run build",
        "build": "tsup src/extension.ts --format cjs --dts --out-dir dist --external vscode",
        "watch": "tsup src/extension.ts --watch --format cjs --out-dir dist",
        "package": "vsce package"
    },
    "dependencies": {
        "fast-glob": "^3.3.2",
        "minimatch": "^9.0.5"
    },
    "devDependencies": {
        "@types/node": "^24.2.1",
        "@types/vscode": "^1.102.0",
        "@vscode/vsce": "^3.6.0",
        "tsup": "^8.5.0",
        "typescript": "^5.6"
    }
}
```

## extension/src/extension.ts

```typescript
﻿import * as vscode from 'vscode';
import { htmlForWebview, Graph } from './util';
import { buildImportGraph } from './graph';
import { getChangedFiles, watchGitState } from './git';
import * as lsp from './lsp';

let panel: vscode.WebviewPanel | undefined;

export function activate(context: vscode.ExtensionContext) {
    context.subscriptions.push(
        vscode.commands.registerCommand('codeCanvas.open', () => openPanel(context)),
        vscode.commands.registerCommand('codeCanvas.openChanged', async () => {
            await ensurePanel(context);
            const files = await getChangedFiles();
            panel?.webview.postMessage({ type: 'openChanged', files });
        }),
        vscode.commands.registerCommand('codeCanvas.layout.custom', () => panel?.webview.postMessage({ type: 'layout', algo: 'custom' })),
        vscode.commands.registerCommand('codeCanvas.layout.dagre', () => panel?.webview.postMessage({ type: 'layout', algo: 'dagre' })),
        vscode.commands.registerCommand('codeCanvas.layout.elk', () => panel?.webview.postMessage({ type: 'layout', algo: 'elk' })),
        vscode.commands.registerCommand('codeCanvas.layout.force', () => panel?.webview.postMessage({ type: 'layout', algo: 'force' })),
        vscode.commands.registerCommand('codeCanvas.toggleRefs', () => panel?.webview.postMessage({ type: 'toggleRefs' }))
    );

    vscode.workspace.onDidChangeTextDocument(async (e) => {
        if (!panel) return;
        panel.webview.postMessage({ type: 'docChanged', file: e.document.uri.fsPath });
    });

    watchGitState(async () => {
        if (!panel) return;
        const files = await getChangedFiles();
        panel.webview.postMessage({ type: 'gitChanged', files });
    });
}

async function ensurePanel(context: vscode.ExtensionContext) { if (!panel) openPanel(context); }

function openPanel(context: vscode.ExtensionContext) {
    const column = vscode.ViewColumn.Beside;
    panel = vscode.window.createWebviewPanel('codeCanvas', 'Code Canvas', column, {
        enableScripts: true,
        retainContextWhenHidden: true,
        localResourceRoots: [vscode.Uri.joinPath(context.extensionUri, 'media')]
    });
    panel.webview.html = htmlForWebview(panel, context);
    panel.onDidDispose(() => panel = undefined);

    panel.webview.onDidReceiveMessage(async (msg) => {
        switch (msg.type) {
            case 'requestGraph': {
                const ws = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath || process.cwd();
                const graph: Graph = await buildImportGraph(ws);
                panel?.webview.postMessage({ type: 'graph', graph });
                break;
            }
            case 'openFile': {
                const uri = vscode.Uri.file(msg.path);
                vscode.window.showTextDocument(uri, { preview: false });
                break;
            }
            case 'requestChanged': {
                const files = await getChangedFiles();
                panel?.webview.postMessage({ type: 'changedFiles', files });
                break;
            }
            case 'requestRefs': {
                const { path, line, character } = msg;
                const uri = vscode.Uri.file(path);
                const refs = await lsp.getReferences(uri, new vscode.Position(line, character));
                panel?.webview.postMessage({ type: 'refs', at: { path, line, character }, refs });
                break;
            }
            case 'requestCalls': {
                const { path, line, character } = msg;
                const uri = vscode.Uri.file(path);
                const incoming = await lsp.getCallHierarchyIncoming(uri, new vscode.Position(line, character));
                const outgoing = await lsp.getCallHierarchyOutgoing(uri, new vscode.Position(line, character));
                panel?.webview.postMessage({ type: 'calls', at: { path, line, character }, incoming, outgoing });
                break;
            }
        }
    });
}

export function deactivate() { }
```

## extension/src/git.ts

```typescript
﻿import * as vscode from 'vscode';

export async function getChangedFiles(): Promise<string[]> {
    // Prefer Git extension API if available
    const gitExt = vscode.extensions.getExtension('vscode.git');
    if (gitExt) {
        const api = (gitExt.isActive ? gitExt.exports : await gitExt.activate()).getAPI(1);
        const repo = api.repositories[0];
        if (repo) {
            const files = [
                ...repo.state.workingTreeChanges,
                ...repo.state.mergeChanges,
                ...repo.state.indexChanges
            ].map(c => c.uri.fsPath);
            return Array.from(new Set(files));
        }
    }
    // Fallback: simple status parse
    try {
        const cp = await import('child_process');
        const { stdout } = cp.spawnSync('git', ['status', '--porcelain'], { encoding: 'utf8' });
        return stdout.split('\n').filter(Boolean).map(line => line.slice(3)).filter(Boolean);
    } catch { return []; }
}

export function watchGitState(onChange: () => void) {
    const gitExt = vscode.extensions.getExtension('vscode.git');
    if (!gitExt) return () => { };
    const add = async () => {
        const api = (gitExt.isActive ? gitExt.exports : await gitExt.activate()).getAPI(1);
        const repo = api.repositories[0];
        if (!repo) return () => { };
        const d1 = repo.state.onDidChange(onChange);
        const d2 = api.onDidOpenRepository(onChange);
        const d3 = api.onDidChangeState(onChange);
        return () => { d1.dispose(); d2.dispose(); d3.dispose(); };
    };
    add();
    return () => { };
}
```

## extension/src/graph.ts

```typescript
﻿import fg from 'fast-glob';
import * as path from 'path';
import * as fs from 'fs';
import type { Graph } from './util';

const JS_GLOB = ['**/*.{js,jsx,ts,tsx}', '!**/node_modules/**', '!**/dist/**', '!**/build/**'];
const PY_GLOB = ['**/*.py', '!**/.venv/**', '!**/__pycache__/**'];

export async function buildImportGraph(root: string): Promise<Graph> {
    const files = Array.from(new Set([
        ...await fg(JS_GLOB, { cwd: root, absolute: true }),
        ...await fg(PY_GLOB, { cwd: root, absolute: true })
    ]));
    const nodes = files.map(f => ({
        id: f,
        label: path.basename(f),
        path: f,
        lang: f.endsWith('.py') ? 'py' : f.endsWith('.ts') || f.endsWith('.tsx') ? 'ts' : 'js'
    }));

    const edges: Graph['edges'] = [];
    for (const f of files) {
        const src = fs.readFileSync(f, 'utf8');
        if (f.endsWith('.py')) parsePyImports(src).forEach(t => pushEdge(edges, f, resolvePy(root, f, t)));
        else parseJsTsImports(src).forEach(t => pushEdge(edges, f, resolveJsTs(root, f, t)));
    }

    return { nodes, edges };
}

function pushEdge(edges: Graph['edges'], sourcePath: string, targetPath?: string) {
    if (!targetPath) return;
    edges.push({ id: `${sourcePath}->${targetPath}`, source: sourcePath, target: targetPath, kind: 'import' });
}

function parseJsTsImports(code: string): string[] {
    const out: string[] = [];
    const r1 = /import\s+[^'"`]+from\s+['"]([^'"`]+)['"]/g; // import X from 'y'
    const r2 = /import\s+['"]([^'"`]+)['"]/g;                 // import 'y'
    const r3 = /export\s+\*?\s*from\s+['"]([^'"`]+)['"]/g;  // export ... from 'y'
    for (const r of [r1, r2, r3]) { let m; while ((m = r.exec(code))) out.push(m[1]); }
    return out;
}

function parsePyImports(code: string): string[] {
    const out: string[] = [];
    const r1 = /^\s*import\s+([\w\.]+)(\s+as\s+\w+)?/gm;          // import a.b as c
    const r2 = /^\s*from\s+([\w\.]+)\s+import\s+[\w\*,\s]+/gm;   // from a.b import c
    let m; while ((m = r1.exec(code))) out.push(m[1]);
    while ((m = r2.exec(code))) out.push(m[1]);
    return out;
}

function resolveJsTs(root: string, fromFile: string, spec: string): string | undefined {
    if (!spec.startsWith('.') && !spec.startsWith('/')) return; // skip package imports for now
    const base = path.resolve(path.dirname(fromFile), spec);
    const tries = ['', '.ts', '.tsx', '.js', '.jsx', '/index.ts', '/index.tsx', '/index.js', '/index.jsx'];
    for (const t of tries) {
        const p = base + t;
        if (fs.existsSync(p)) return p;
    }
    return undefined;
}

function resolvePy(root: string, fromFile: string, mod: string): string | undefined {
    // rudimentary resolver: convert dotted module to path near project root
    // tries sibling packages and project packages; falls back to __init__.py
    const parts = mod.split('.');
    const candidates = [
        path.resolve(root, ...parts) + '.py',
        path.resolve(root, ...parts, '__init__.py')
    ];
    for (const p of candidates) if (require('fs').existsSync(p)) return p;
    return undefined;
}
```

## extension/src/lsp.ts

```typescript
﻿import * as vscode from 'vscode';

export async function getReferences(uri: vscode.Uri, position: vscode.Position) {
    const locs = await vscode.commands.executeCommand<vscode.Location[]>(
        'vscode.executeReferenceProvider', uri, position
    );
    return (locs || []).map(l => ({
        uri: l.uri.toString(),
        range: { start: l.range.start, end: l.range.end }
    }));
}

export async function getDefinition(uri: vscode.Uri, position: vscode.Position) {
    const defs = await vscode.commands.executeCommand<any>('vscode.executeDefinitionProvider', uri, position);
    return defs;
}

export async function getCallHierarchyIncoming(uri: vscode.Uri, position: vscode.Position) {
    const items = await vscode.commands.executeCommand<any>('vscode.prepareCallHierarchy', uri, position);
    if (!items || !items[0]) return [];
    const incoming = await vscode.commands.executeCommand<any>('vscode.provideIncomingCalls', items[0]);
    return incoming || [];
}

export async function getCallHierarchyOutgoing(uri: vscode.Uri, position: vscode.Position) {
    const items = await vscode.commands.executeCommand<any>('vscode.prepareCallHierarchy', uri, position);
    if (!items || !items[0]) return [];
    const outgoing = await vscode.commands.executeCommand<any>('vscode.provideOutgoingCalls', items[0]);
    return outgoing || [];
}
```

## extension/src/util.ts

```typescript
﻿import * as vscode from 'vscode';

export function htmlForWebview(panel: vscode.WebviewPanel, context: vscode.ExtensionContext) {
    const media = vscode.Uri.joinPath(context.extensionUri, 'media');
    const index = vscode.Uri.joinPath(media, 'index.html');
    let html = Buffer.from(require('fs').readFileSync(index.fsPath)).toString('utf8');

    const fix = (p: string) => panel.webview.asWebviewUri(vscode.Uri.joinPath(media, p)).toString();
    html = html
        .replace(/\"\/assets\//g, `"${fix('assets/')}`)
        .replace(/__CSP__/g, panel.webview.cspSource);
    return html;
}

export type GraphNode = { id: string; label: string; path: string; lang: 'ts' | 'js' | 'tsx' | 'jsx' | 'py' | 'other'; };
export type GraphEdge = { id: string; source: string; target: string; kind: 'import' | 'call' | 'ref'; };
export type Graph = { nodes: GraphNode[]; edges: GraphEdge[] };
```

## extension/tsconfig.json

```json
﻿{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2022"],
    "module": "ESNext",
    "moduleResolution": "Node",
    "strict": true,
    "skipLibCheck": true,
    "outDir": "dist",
    "rootDir": "src",
    "types": ["vscode", "node"]
  },
  "include": ["src/**/*.ts"]
}
```

## package.json

```json
{
  "name": "code-canvas",
  "private": true,
  "version": "1.0.0",
  "description": "Code Canvas",
  "main": "index.js",
  "scripts": {
    "build": "npm -w webview run build && npm -w extension run build",
    "watch": "npm -w webview run dev & npm -w extension run watch",
    "package": "npm -w extension run package"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "type": "commonjs",
  "workspaces": [
    "webview",
    "extension"
  ],
  "overrides": {}
}
```

## README.md

```markdown
﻿# paste: README.md
```

## webview/index.html

```html
﻿<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; img-src vscode-resource: https: data:; style-src 'unsafe-inline' __CSP__; script-src __CSP__; font-src __CSP__; connect-src __CSP__;" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Code Canvas</title>
</head>

<body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
</body>

</html>
```

## webview/package.json

```json
{
    "name": "code-canvas-webview",
    "private": true,
    "version": "0.0.1",
    "type": "module",
    "scripts": {
        "dev": "vite",
        "build": "vite build"
    },
    "dependencies": {
        "dagre": "^0.8.5",
        "elkjs": "^0.10.0",
        "highlight.js": "^11.9.0",
        "react": "^18.3.1",
        "react-dom": "^18.3.1",
        "reactflow": "^11.11.4"
    },
    "devDependencies": {
        "@types/react": "^18.3.3",
        "@types/react-dom": "^18.3.0",
        "typescript": "^5.6",
        "vite": "^7.1.2"
    }
}
```

## webview/src/App.tsx

```text
﻿import React, { useEffect, useMemo, useRef, useState } from 'react';
import ReactFlow, { Background, Controls, MiniMap } from 'reactflow';
import 'reactflow/dist/style.css';
import { nodeTypes } from './reactflow-node-types';
import CodeCard from './code/CodeCard';
import { dagreLayout, elkLayout } from './layout';

// VS Code webview API
declare global { interface Window { acquireVsCodeApi: any } }
const vscode = window.acquireVsCodeApi?.();

type Node = { id: string; type: 'file'; position: { x: number; y: number }; data: any; style?: any };

export default function App() {
    const [graph, setGraph] = useState<{ nodes: any[]; edges: any[] }>({ nodes: [], edges: [] });
    const [nodes, setNodes] = useState<Node[]>([]);
    const [edges, setEdges] = useState<any[]>([]);
    const lastAlgo = useRef<'custom' | 'dagre' | 'elk' | 'force'>('custom');
    const [showRefs, setShowRefs] = useState(true);

    useEffect(() => {
        vscode?.postMessage({ type: 'requestGraph' });
        vscode?.postMessage({ type: 'requestChanged' });
        const listener = (e: MessageEvent) => {
            const msg = e.data;
            if (msg.type === 'graph') {
                setGraph(msg.graph);
            } else if (msg.type === 'changedFiles') {
                openFiles(msg.files);
            } else if (msg.type === 'openChanged') {
                openFiles(msg.files);
            } else if (msg.type === 'layout') {
                layout(msg.algo);
            } else if (msg.type === 'toggleRefs') {
                setShowRefs(s => !s);
            }
        };
        window.addEventListener('message', listener);
        return () => window.removeEventListener('message', listener);
    }, []);

    useEffect(() => { // build ReactFlow nodes
        const initial: Node[] = graph.nodes.map((n: any, i: number) => ({
            id: n.id,
            type: 'file',
            position: { x: (i % 5) * 400, y: Math.floor(i / 5) * 220 },
            style: { width: 360, height: 200 },
            data: { label: n.label, preview: (<div className="preview">{n.path}</div>), path: n.path, lang: n.lang }
        }));
        const e = graph.edges.map((e: any) => ({ id: e.id, source: e.source, target: e.target }));
        setNodes(initial); setEdges(e);
    }, [graph]);

    function openFiles(paths: string[]) {
        setNodes(prev => {
            const ids = new Set(prev.map(p => p.id));
            const add: Node[] = graph.nodes.filter((n: any) => paths.includes(n.path) && !ids.has(n.id)).map((n: any, i: number) => ({
                id: n.id, type: 'file', position: { x: 50 + i * 30, y: 60 + i * 30 }, style: { width: 480, height: 280 },
                data: { label: n.label, preview: <div className="preview">{n.path}</div>, path: n.path, lang: n.lang }
            }));
            return [...prev, ...add];
        });
    }

    async function layout(algo: 'custom' | 'dagre' | 'elk' | 'force') {
        lastAlgo.current = algo;
        if (algo === 'dagre') setNodes(await dagreLayout(nodes as any, edges as any) as any);
        else if (algo === 'elk') setNodes(await elkLayout(nodes as any, edges as any) as any);
        else if (algo === 'force') {
            // Simple force: jitter spread
            setNodes(nodes.map((n, i) => ({ ...n, position: { x: i * 120 % 1200, y: (i * 220) % 800 } })));
        }
    }

    function onOpenFile(n: Node) { vscode?.postMessage({ type: 'openFile', path: n.data.path }); }

    function onTokenClick({ path, line, character, token }: any) {
        if (!showRefs) return;
        vscode?.postMessage({ type: 'requestRefs', path, line, character, token });
    }

    // render code previews lazily inside each node
    const nodeTypesLocal = useMemo(() => ({
        file: (p: any) => {
            const n = p.data;
            return (
                <div className="file-node">
                    <div className="file-node-header" onDoubleClick={() => onOpenFile(p)}>{n.label}</div>
                    <CodeCard file={n.path} lang={n.lang} content={window.__CODE_CACHE?.[n.path] || n.path} onTokenClick={onTokenClick} />
                </div>
            );
        }
    }), []);

    return (
        <div className="root">
            <div className="toolbar">
                <button onClick={() => layout('custom')}>Custom (⇧1)</button>
                <button onClick={() => layout('dagre')}>Dagre (⇧2)</button>
                <button onClick={() => layout('elk')}>ELK (⇧3)</button>
                <button onClick={() => layout('force')}>Force (⇧4)</button>
                <button onClick={() => vscode?.postMessage({ type: 'requestChanged' })}>Open Changed (⇧O)</button>
                <button onClick={() => vscode?.postMessage({ type: 'toggleRefs' })}>Refs (R)</button>
            </div>
            <ReactFlow nodes={nodes as any} edges={edges} nodeTypes={nodeTypesLocal as any} fitView>
                <Background />
                <MiniMap pannable zoomable />
                <Controls />
            </ReactFlow>
        </div>
    );
}
```

## webview/src/code/CodeCard.tsx

```text
﻿import React, { useMemo } from 'react';
import { highlight } from './highlight';

export default function CodeCard({ file, lang, content, onTokenClick }: {
    file: string; lang: 'ts' | 'js' | 'py' | 'other'; content: string; onTokenClick: (payload: { path: string; line: number; character: number; token: string }) => void;
}) {
    const html = useMemo(() => highlight(content, lang), [content, lang]);

    const onClick: React.MouseEventHandler<HTMLPreElement> = (e) => {
        // lightweight token guess: find word under click using selection API
        const sel = window.getSelection();
        if (!sel || sel.toString().length === 0) return;
        const token = sel.toString();
        // estimate position: count lines and chars up to anchorNode
        const range = sel.getRangeAt(0);
        const pre = range.startContainer.ownerDocument?.getElementById(`code-${file}`);
        if (!pre) return;
        const text = pre.textContent || '';
        const before = text.slice(0, text.indexOf(token));
        const line = before.split('\n').length - 1;
        const character = before.split('\n').pop()!.length;
        onTokenClick({ path: file, line, character, token });
    };

    return (
        <div className="code-card">
            <div className="file-title">{file}</div>
            <pre id={`code-${file}`} className="hljs" onMouseUp={onClick} dangerouslySetInnerHTML={{ __html: html }} />
        </div>
    );
}
```

## webview/src/code/highlight.ts

```typescript
﻿import hljs from 'highlight.js/lib/core';
import ts from 'highlight.js/lib/languages/typescript';
import js from 'highlight.js/lib/languages/javascript';
import py from 'highlight.js/lib/languages/python';

hljs.registerLanguage('typescript', ts);
hljs.registerLanguage('javascript', js);
hljs.registerLanguage('python', py);

export function highlight(code: string, lang: 'ts' | 'js' | 'py' | 'other') {
    const l = lang === 'ts' ? 'typescript' : lang === 'js' ? 'javascript' : lang === 'py' ? 'python' : 'plaintext';
    try { return hljs.highlight(code, { language: l }).value; } catch { return hljs.highlightAuto(code).value; }
}
```

## webview/src/layout.ts

```typescript
﻿import dagre from 'dagre';
import ELK from 'elkjs/lib/elk.bundled.js';

export function dagreLayout(nodes: any[], edges: any[], direction: 'LR' | 'TB' = 'LR') {
    const g = new dagre.graphlib.Graph();
    g.setGraph({ rankdir: direction });
    g.setDefaultEdgeLabel(() => ({}));
    nodes.forEach(n => g.setNode(n.id, { width: n.style?.width || 300, height: n.style?.height || 120 }));
    edges.forEach(e => g.setEdge(e.source, e.target));
    dagre.layout(g);
    return nodes.map(n => { const p = g.node(n.id); return { ...n, position: { x: p.x, y: p.y } }; });
}

const elk = new ELK();
export async function elkLayout(nodes: any[], edges: any[]) {
    const graph = {
        id: 'root',
        layoutOptions: { 'elk.algorithm': 'layered', 'elk.direction': 'RIGHT' },
        children: nodes.map(n => ({ id: n.id, width: n.style?.width || 300, height: n.style?.height || 120 })),
        edges: edges.map(e => ({ id: e.id, sources: [e.source], targets: [e.target] }))
    } as any;
    const res = await elk.layout(graph);
    const pos: Record<string, { x: number; y: number }> = {};
    res.children?.forEach((c: any) => { pos[c.id] = { x: c.x, y: c.y }; });
    return nodes.map(n => ({ ...n, position: pos[n.id] || n.position }));
}
```

## webview/src/main.tsx

```text
﻿import React from 'react';
import { createRoot } from 'react-dom/client';
import App from './App';
import './styles.css';

createRoot(document.getElementById('root')!).render(<App />);
```

## webview/src/reactflow-node-types.tsx

```text
﻿import React from 'react';
import { Handle, Position } from 'reactflow';

export function FileNode({ data }: any) {
    return (
        <div className="file-node">
            <div className="file-node-header">{data.label}</div>
            <div className="file-node-body">{data.preview}</div>
            <Handle type="source" position={Position.Right} />
            <Handle type="target" position={Position.Left} />
        </div>
    );
}

export const nodeTypes = { file: FileNode } as const;
```

## webview/src/styles.css

```css
﻿:root {
    color-scheme: dark;
}

body,
html,
#root {
    margin: 0;
    height: 100%;
    background: #0b0e12;
    color: #cdd6f4;
    font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Inter, sans-serif;
}

.root {
    height: 100%;
}

.toolbar {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 10;
    display: flex;
    gap: 6px;
}

.toolbar button {
    background: #111827;
    border: 1px solid #1f2937;
    color: #e5e7eb;
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
}

.file-node {
    width: 100%;
    height: 100%;
    background: #0d1117;
    border: 1px solid #1f2937;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 0 0 1px #0b1220 inset;
}

.file-node-header {
    background: #0b1220;
    padding: 6px 10px;
    font-weight: 600;
    font-size: 12px;
    letter-spacing: .3px;
    border-bottom: 1px solid #1f2937;
    cursor: default;
}

.code-card {
    height: calc(100% - 30px);
    overflow: auto;
}

.code-card .file-title {
    display: none;
}

pre.hljs {
    margin: 0;
    padding: 8px 10px;
    font-size: 12px;
    line-height: 1.35;
}

.preview {
    font-size: 11px;
    opacity: .8;
    padding: 8px;
}
```

## webview/tsconfig.json

```json
﻿{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "jsx": "react-jsx",
    "allowJs": false,
    "strict": true,
    "skipLibCheck": true,
    "noEmit": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "useDefineForClassFields": true
  },
  "include": ["src"]
}
```

## webview/vite.config.ts

```typescript
﻿import { defineConfig } from 'vite';
import path from 'path';

export default defineConfig({
    base: '',
    build: {
        outDir: path.resolve(__dirname, '../extension/media'),
        emptyOutDir: true,
        rollupOptions: {
            input: path.resolve(__dirname, 'index.html')
        }
    }
});
```

## Statistics

- Total Files: 22
- Total Characters: 1898023
- Total Tokens: 0
